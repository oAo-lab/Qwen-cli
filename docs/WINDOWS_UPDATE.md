# Windows 自动更新系统

## 概述

Qwen-cli 在 Windows 平台使用外部更新器（ask_updater）来实现自动更新功能，避免了批处理脚本被杀毒软件拦截的问题。

## 工作原理

1. **主程序检测更新**：主程序检查 GitHub Releases 是否有新版本
2. **检查更新器**：检查本地是否存在更新器程序
3. **按需下载更新器**：如果不存在，从 GitHub Releases 下载对应版本的更新器
4. **下载新版本**：将新版本下载到临时目录
5. **启动更新器**：主程序启动 `ask_updater.exe` 并退出
6. **更新器接管**：更新器等待主程序退出，然后替换文件并重启新版本

## 文件结构

```
Qwen-cli/
├── ask.exe              # 主程序
└── temp/                # 临时文件目录
    ├── ask_updater.exe  # 按需下载的更新器
    └── qwen-cli-*.exe   # 下载的新版本
```

### 更新器下载逻辑

- **首次更新**：用户执行 `ask update` 时自动下载更新器到临时目录
- **后续更新**：复用已下载的更新器，避免重复下载
- **版本匹配**：更新器版本与主程序版本保持一致
- **自动清理**：更新器保存在临时目录，由系统自动清理

## 构建说明

### 使用 Makefile

```bash
# 构建所有平台版本（包括 Windows 更新器）
make build-all
```

### 使用 GoReleaser

```bash
# 发布新版本（会自动构建更新器）
make push
```

## 更新器功能

### 核心特性

- **智能等待**：自动等待主程序退出，避免文件锁定问题
- **备份机制**：自动备份当前版本，更新失败时可回滚
- **错误处理**：完善的错误处理和用户提示
- **自动清理**：更新完成后自动清理临时文件和备份

### 使用方法

更新器通常由主程序自动调用，无需手动操作。更新器会在以下情况自动下载：

1. **首次执行更新命令**：`ask update` 时检查并下载更新器
2. **更新器不存在**：临时目录中没有找到更新器时自动下载
3. **版本不匹配**：如果需要特定版本的更新器，会重新下载

如果需要手动使用更新器：

```bash
# 手动运行更新器（通常在临时目录中）
%TEMP%\ask_updater.exe <目标程序路径> <新程序路径>

# 示例
%TEMP%\ask_updater.exe C:\Program Files\Qwen-cli\ask.exe C:\temp\new-version.exe
```

## 安全性

- **数字签名**：建议对主程序和更新器进行数字签名
- **权限控制**：更新器只替换指定文件，不会执行其他操作
- **文件验证**：更新前会验证文件完整性

## 故障排除

### 常见问题

1. **更新器下载失败**
   - 检查网络连接是否正常
   - 确认 GitHub Releases 中有对应版本的更新器
   - 检查防火墙或杀毒软件是否阻止下载

2. **找不到更新器**
   - 更新器会自动下载，无需手动放置
   - 检查临时目录权限是否正常
   - 查看下载过程中的错误信息

3. **更新失败**
   - 检查是否有足够的磁盘空间
   - 确保对目标目录有写入权限
   - 查看更新器输出的错误信息

4. **文件被锁定**
   - 更新器会自动等待程序退出
   - 如果等待超时，请手动关闭所有 Qwen-cli 进程

### 日志查看

更新器会输出详细的更新过程信息，包括：
- 目标程序路径
- 新程序路径
- 备份操作
- 替换操作
- 错误信息（如果有）

## 开发者信息

### 源代码位置

- 主程序：`cmd/main.go`
- 更新器：`cmd/updater/main.go`
- 版本管理：`version/version.go`

### 构建配置

- Makefile：`makefile`
- GoReleaser：`.goreleaser.yaml`

### 版本信息

更新器与主程序使用相同的版本信息，通过构建参数注入：
- `Version`：版本号
- `GitCommit`：Git 提交哈希
- `BuildDate`：构建日期

## 更新流程图

```
┌─────────────┐    ┌──────────────┐    ┌─────────────┐
│   主程序    │    │  检查更新器   │    │  下载更新器  │
│             │───▶│              │───▶│             │
│ 检查更新     │    │ 是否存在      │    │ 按需下载     │
└─────────────┘    └──────────────┘    └─────────────┘
        │                                        │
        ▼                                        ▼
┌─────────────┐    ┌──────────────┐    ┌─────────────┐
│   下载新版本 │    │   启动更新器  │    │   等待退出   │
│             │───▶│              │───▶│             │
│ 到临时目录    │    │ 并退出主程序  │    │ 主程序       │
└─────────────┘    └──────────────┘    └─────────────┘
                                                        │
                                                        ▼
┌─────────────┐    ┌──────────────┐    ┌─────────────┐
│   更新器    │    │   替换文件    │    │   重启程序   │
│             │───▶│              │───▶│             │
│ 启动        │    │ 并备份旧版本  │    │ 新版本       │
└─────────────┘    └──────────────┘    └─────────────┘
```

## 兼容性

- **Windows 7/8/10/11**：完全支持
- **杀毒软件**：使用标准 Windows API，兼容主流杀毒软件
- **权限要求**：需要程序所在目录的写入权限